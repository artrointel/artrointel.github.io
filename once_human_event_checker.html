<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>원스 휴먼 이벤트 타이머</title>
  <style>@import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
    :root {
      --bg-color: #f9f9f9;
      --box-bg: #ffffffcc;
      --border-color: #b3d9ff;
      --accent-color: #a7c7e7;
      --text-color: #333;
      --placeholder-color: #00000040;
      --button-bg: linear-gradient(135deg, #a7c7e7, #88aadd);
      --button-bg-translucent: rgba(0, 0, 0, 0.2);
    }
    body.dark {
      --bg-color: #222;
      --box-bg: #333333cc;
      --border-color: #888;
      --accent-color: #d5b3ff;
      --text-color: #eee;
      --placeholder-color: #ffffff40;
      --button-bg: linear-gradient(135deg, #d5b3ff, #bb99ee);
      --button-bg-translucent: rgba(255, 255, 255, 0.2);
    }
    body.dark .left-pane,
    body.dark .right-pane {
      background-color: var(--box-bg);
      color: var(--text-color);
    }
    body.dark .memo {
      background-color: var(--box-bg);
      border-color: var(--border-color);
    }
    body.dark .memo-header {
      background-color: #444;
      color: var(--text-color);
    }
    body.dark .memo-content {
      background-color: #333;
      color: var(--text-color);
    }
    body {
      font-family: 'Gowun Dodum', sans-serif;
      font-size: 120%;
      padding: 20px;
      background: var(--bg-color);
      color: var(--text-color);
      position: relative;
      min-height: 100vh;
      background-size: 300px 300px;
      transition: background 0.3s, color 0.3s;
    }
    input, button {
      font-family: 'Gowun Dodum', sans-serif;
      font-size: 100%;
      border: 1px solid var(--border-color);
    }    
    #container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .event-row {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .complete-btn {
      transition: background-color 0.3s ease;
    }
    .complete-btn:hover {
      background-color: #ccddee;
    }
    .character-box {
      background: var(--box-bg);
      border: px solid var(--border-color);
      border-radius: 20px;
      padding: 15px;
      width: 280px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .character-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .character-name {
      border: 1px solid var(--border-color);
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      border-radius: 8px;
      margin-bottom: 15px;
      width: 100%;
      background: var(--box-bg);
      color: var(--text-color);
    }
    .event-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .event-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    .event-icon {
      width: 30px;
      height: 30px;
      margin-right: 4px;
    }
    .event-label {
      width: 90px;
      font-size: 16px;
      color: var(--text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .timer {
      border: 1px solid var(--accent-color);
      border-radius: 8px;
      padding: 5px 8px;
      font-size: 14px;
      width: 60px;
      text-align: center;
      background: var(--box-bg);
    }
    .complete-btn {
      background: #e0e0e0;
      border: 1px solid #999;
      padding: 4px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .complete-btn:hover {
      background: #ccc;
    }
    .progress-bar {
      margin-top: 5px;
      width: 100%;
      height: 6px;
      background: #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      width: 0%;
      background: var(--accent-color);
      transition: width 1s linear;
    }
    .alarm-toggle {
      display: flex;
      align-items: center;
      margin-top: 15px;
      gap: 6px;
      justify-content: space-between;
    }
    .alarm-toggle input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-color);
    }
    input::placeholder {
      color: var(--placeholder-color);
      font-style: italic;
    }
    .delete-btn {
      background: #ffaaaa;
      border: 1px solid #cc6666;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .delete-btn:hover {
      background: #ff8888;
    }
    .add-button, .theme-toggle {
      font-size: 20px;
      height: 45px;
      width: 45px;
      border-radius: 50%;
      border: none;
      color: white;
      cursor: pointer;
      text-align: center;
      user-select: none;
      position: fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      z-index: 100;
      background-color: var(--button-bg-translucent);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .add-button {
      bottom: 20px;
      right: 20px;
    }
    .theme-toggle {
      top: 20px;
      right: 20px;
    }
    .add-button:hover, .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    .split-container {
      display: flex;
      width: 100%;
      height: 100vh;
    }
    .pane {
      overflow: auto;
      height: 100%;
    }
    .left-pane {
      width: 35%;
      min-width: 250px;
      background-color: #f5f5f5;
      padding: 10px;
      box-sizing: border-box;
    }
    .right-pane {
      flex: 1;
      padding: 10px;
      background-color: #ffffff;
      box-sizing: border-box;
    }
    .resizer {
      width: 3px;
      cursor: col-resize;
      background-color: var(--border-color);
      transition: background-color 0.3s ease;
    }
    .resizer:hover {
      background-color: var(--accent-color);
    }
    body.dark .resizer {
      background-color: #666;
    }
    body.dark .resizer:hover {
      background-color: var(--accent-color);
    }
    .server-status {
      background: var(--box-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 15px;
      color: var(--text-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .server-status table {
      width: 100%;
      border-spacing: 10px;
    }
    .server-status label {
      font-weight: bold;
    }
    .server-status input[type="time"],
    .server-status select {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--box-bg);
      color: var(--text-color);
      box-sizing: border-box;
    }
    .server-status button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background: var(--button-bg);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .server-status button:hover {
      opacity: 0.9;
    }
    .alarm-container {
      background: var(--box-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      margin-top: 12px;
    }
    .alarm-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }
    .alarm-row .move-controls {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .alarm-row .move-controls button {
      background: transparent;
      border: none;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .alarm-row input[type="time"], .alarm-row input[type="text"] {
      padding: 4px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--box-bg);
      color: var(--text-color);
    }
    .alarm-row input[type="time"] {
      flex: 0 0 100px;
    }
    .alarm-row input.desc {
      flex-grow: 1;
    }
    .alarm-row label.toggle {
      font-size: 14px;
      margin-right: 4px;
    }
    .alarm-row input[type="checkbox"] {
      transform: scale(1.2);
    }
    .alarm-row button {
      background: #ffaaaa;
      border: 1px solid #cc6666;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .alarm-row button:hover {
      background: #ff8888;
    }
    .alarm-buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .alarm-add-button {
      flex: 4;
      padding: 6px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      color: white;
      transition: background 0.2s;
      background: var(--button-bg);
    }
    .alarm-reset-button {
      flex: 1;
      padding: 6px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      color: white;
      transition: background 0.2s;
      background: #8888ff;
    }
    .alarm-add-button:hover, .alarm-reset-button:hover {
      opacity: 0.9;
    }
    .memo-list {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 4px;
    }
    .memo {
      margin-top: 5px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fff;
      overflow: hidden;
      animation: fade-in 0.5s ease;
    }
    .memo-header {
      padding: 5px 10px;
      background: #e0e0e0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .memo.fade-out {
      animation: fade-out 1s ease forwards;
    }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fade-out {
      from { opacity: 1; }
      to { opacity: 0; height: 0; margin: 0; padding: 0; }
    }
    .memo-title {
      background: transparent;
      border: none;
      font-size: 14px;
      font-weight: 500;
      height: 24px;
      color: inherit;
    }
    .memo-title:focus {
      outline: 2px solid var(--accent-color);
      background-color: var(--box-bg);
    }
    .memo-header button {
      padding: 2px 8px;
      font-size: 13px;
      height: 28px;
    }
    .memo-content {
      display: none;
      padding: 10px;
    }
    .memo-content.active {
      display: block;
    }
    .quill-editor {
      height: 150px;
    }
    .memo-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
      overflow: hidden;
    }
    .memo-group.collapsed {
      max-height: 0;
      overflow: hidden;
    }
    .memo-float-toggle {
      position: fixed;
      bottom: 20px;
      right: 80px;
      font-size: 20px;
      height: 45px;
      width: 45px;      
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      text-align: center;
      line-height: 60px;
      user-select: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--button-bg-translucent);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .memo-float-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    body.dark .ql-toolbar.ql-snow {
      background-color: #444;
      border-color: #666;
    }
    body.dark .ql-toolbar.ql-snow .ql-picker-label,
    body.dark .ql-toolbar.ql-snow .ql-stroke,
    body.dark .ql-toolbar.ql-snow .ql-fill,
    body.dark .ql-toolbar.ql-snow .ql-picker {
      color: #eee;
      stroke: #eee;
      
    }
    body.dark .ql-container.ql-snow {
      background-color: #222;
      border-color: #666;
      color: #eee;
    }
    body.dark .ql-editor {
      color: #eee;
    }
    body.dark .ql-picker {
      color: #eee;
    }
    .add-btn {
      margin-bottom: 10px;
      width: 100%;
      padding: 8px;
      font-size: 16px;
    }
    .settings-button {
      position: fixed;
      top: 20px;
      right: 80px;
      z-index: 101;
      font-size: 20px;
      height: 45px;
      width: 45px;
      border-radius: 50%;
      border: none;
      color: white;
      cursor: pointer;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      background-color: var(--button-bg-translucent);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }


    .settings-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .settings-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--box-bg);
      border: 1px solid var(--border-color);
      padding: 20px;
      border-radius: 12px;
      z-index: 200;
      min-width: 320px; width: fit-content; max-width: 90vw;
      display: none;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .settings-modal h3 {
      margin-top: 0;
      font-size: 18px;
      color: var(--text-color);
    }

    .setting-item {
      margin-bottom: 16px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .setting-item label {
      margin: 0;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="split-container">
    <div class="pane left-pane" id="memo-pane">
      <div class="server-status">
        <table>
          <tr>
            <td><label for="trans-mode">트랜스 현상</label></td>
            <td colspan="2">
              <select id="trans-mode" onchange="saveTransToCookie(); renderAlarmList();">
                <option value="없음">없음</option>
                <option value="달의 징조">달의 징조</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="ingame-time">현재 인게임 시간</label></td>
            <td colspan="2"><input type="time" id="ingame-time" value="00:00" onchange="setIngameClockBase()"></td>
          </tr>
        </table>
        <div id="alarm-section" class="alarm-container"></div>
        <div class="alarm-buttons">
          <button class="alarm-add-button" onclick="addAlarmRow()">+ 알림 추가</button>
          <button class="alarm-reset-button" onclick="resetAlarmsToDefault()">🔄 초기화</button>
        </div>        
      </div>
      <div id="memo-group" class="memo-group">
        <button class="add-btn" onclick="addMemo()">메모 추가</button>
        <div class="memo-list" id="memo-list"></div>
      </div>
    </div>
    <div class="resizer" id="resizer"></div>
    <div class="pane right-pane" id="event-pane">
      <div id="container"></div>
      <button id="memo-float-toggle" class="memo-float-toggle" onclick="toggleMemoGroupFloating()">📑</button>
      <button class="add-button" onclick="addCharacterBox()">➕</button>
      <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
      <button class="settings-button" onclick="openSettings()">⚙️</button>
    </div>
  </div>
  <div id="settings-modal" class="settings-modal">
    <h3>글로벌 설정</h3>
    <div class="setting-item">
      <label for="tts-volume-range">음성 가이드 볼륨 조절</label>
      <input type="range" id="tts-volume-range" min="0" max="100" value="50" oninput="window.__ttsVolume = this.value / 100; saveGlobalSettingsToCookie()">
    </div>
  </div>
  <!-- Quill Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    function openSettings() {
      const modal = document.getElementById('settings-modal');
      const isOpen = modal.style.display === 'block';
      modal.style.display = isOpen ? 'none' : 'block';
    }

    function saveGlobalSettingsToCookie() {
      const volume = document.getElementById('tts-volume-range').value;
      document.cookie = `ttsVolume=${volume}; path=/; max-age=31536000`;
    }

    function loadGlobalSettingsFromCookie() {
      const match = document.cookie.match(/(?:^|; )ttsVolume=([^;]*)/);
      const volume = match ? parseInt(match[1]) : 50;
      document.getElementById('tts-volume-range').value = volume;
      window.__ttsVolume = volume / 100;
    }

    function saveTransToCookie() {
      const value = document.getElementById('trans-mode').value;
      document.cookie = `transMode=${value}; path=/; max-age=31536000`;
    }

    function loadTransFromCookie() {
      const match = document.cookie.match(/(?:^|; )transMode=([^;]*)/);
      if (match) {
        document.getElementById('trans-mode').value = match[1];
      }
    }

    const defaultPresets = {
      '없음': [],
      '달의 징조': [
        { time: '21:00', label: '달의 징조 시작' },
        { time: '00:00', label: '자정 알림' },
        { time: '03:00', label: '달의 징조 종료' }
      ]
    };

    let alarmPresets = JSON.parse(JSON.stringify(defaultPresets));

    function renderAlarmList() {
      const trans = document.getElementById('trans-mode').value;
      const section = document.getElementById('alarm-section');
      section.innerHTML = '';
      if (!alarmPresets[trans]) return;

      const alarmStates = loadAlarmStatesFromCookie(trans);
      alert(alarmStates);

      alarmPresets[trans].forEach((alarm, index) => {
        const row = createAlarmRow(alarm.time, alarm.label, alarmStates[index], trans);
        section.appendChild(row);
      });
    }

    function createAlarmRow(time, label, checked = true, trans = null) {
      const row = document.createElement('div');
      row.className = 'alarm-row';
      row.innerHTML = `
        <div class="move-controls">
          <button onclick="moveAlarm(this.parentElement.parentElement, 'up')">⬆️</button>
          <button onclick="moveAlarm(this.parentElement.parentElement, 'down')">⬇️</button>
        </div>
        <input type="time" value="${time}" onchange="saveAlarmStatesToCookie()">
        <input type="text" class="desc" value="${label}" onchange="saveAlarmStatesToCookie()">
        <label class="toggle">음성 알림</label>
        <input type="checkbox" ${checked ? 'checked' : ''} onchange="saveAlarmStatesToCookie()">
        <button onclick="this.parentElement.remove(); saveAlarmStatesToCookie()">X</button>
      `;
      return row;
    }

    function resetAlarmsToDefault() {
      const trans = document.getElementById('trans-mode').value;
      if (!defaultPresets[trans]) return;
      alarmPresets[trans] = JSON.parse(JSON.stringify(defaultPresets[trans] || []));
      saveAlarmStatesToCookie();
      renderAlarmList();
    }

    function addAlarmRow() {
      const section = document.getElementById('alarm-section');
      const row = createAlarmRow('00:00', '새 알림', true);
      section.appendChild(row);
      saveAlarmStatesToCookie();
    }

    function saveAlarmStatesToCookie() {
      const trans = document.getElementById('trans-mode').value;
      const rows = document.querySelectorAll('#alarm-section .alarm-row');
      const data = Array.from(rows).map(row => {
        return {
          time: row.querySelector('input[type="time"]').value,
          label: row.querySelector('input.desc').value,
          checked: row.querySelector('input[type="checkbox"]').checked
        };
      });
      document.cookie = `alarmData_${trans}=${JSON.stringify(data)}; path=/; max-age=31536000`;
    }

    function loadAlarmStatesFromCookie(trans) {
      if (!alarmPresets[trans] || !Array.isArray(alarmPresets[trans])) return [];
      const match = document.cookie.match(new RegExp(`(?:^|; )alarmData_${trans}=([^;]*)`));
      if (match) {
        try {
          const data = JSON.parse(decodeURIComponent(match[1]));
          alarmPresets[trans] = data;
          return data.map(d => d.checked);
        } catch {}
      }
      return alarmPresets[trans].map(() => true);
    }

    function checkAlarmTrigger(currentIngameMinutes) {
      const rows = document.querySelectorAll('#alarm-section .alarm-row');
      rows.forEach(row => {
        const timeStr = row.querySelector('input[type="time"]').value;
        const label = row.querySelector('input.desc').value;
        const enabled = row.querySelector('input[type="checkbox"]').checked;
        if (!enabled) return;
        const [hh, mm] = timeStr.split(":").map(Number);
        const alarmMinute = hh * 60 + mm;
        if (alarmMinute === currentIngameMinutes && !row.dataset.triggered) {
          speak(label);
          row.dataset.triggered = 'true';
        } else if (alarmMinute !== currentIngameMinutes) {
          row.dataset.triggered = '';
        }
      });
    }

    function moveAlarm(row, direction) {
      const container = document.getElementById('alarm-section');
      if (direction === 'up' && row.previousElementSibling) {
        container.insertBefore(row, row.previousElementSibling);
      } else if (direction === 'down' && row.nextElementSibling) {
        container.insertBefore(row.nextElementSibling, row);
      }
      saveAlarmStatesToCookie();
    }

    let ingameBaseRealTime = null;
    let ingameBaseTimeMinutes = 0;
    let ingameInterval = null;

    function saveIngameTimeToCookie() {
      document.cookie = `ingameBase=${ingameBaseTimeMinutes}; path=/; max-age=31536000`;
      document.cookie = `ingameRealBase=${new Date().toISOString()}; path=/; max-age=31536000`;
    }

    function loadIngameTimeFromCookie() {
      const baseTimeMatch = document.cookie.match(/(?:^|; )ingameBase=([^;]*)/);
      const baseRealMatch = document.cookie.match(/(?:^|; )ingameRealBase=([^;]*)/);
      if (baseTimeMatch && baseRealMatch) {
        ingameBaseTimeMinutes = parseInt(baseTimeMatch[1]);
        ingameBaseRealTime = new Date(baseRealMatch[1]);
        if (!isNaN(ingameBaseTimeMinutes) && ingameBaseRealTime instanceof Date && !isNaN(ingameBaseRealTime)) {
          ingameInterval = setInterval(updateIngameClock, 1000);
          updateIngameClock();
        }
      }
    }

    function setIngameClockBase() {
      const input = document.getElementById('ingame-time');
      const [hh, mm] = input.value.split(":").map(Number);
      ingameBaseRealTime = new Date();
      ingameBaseTimeMinutes = hh * 60 + mm;
      if (ingameInterval) clearInterval(ingameInterval);
      ingameInterval = setInterval(updateIngameClock, 1000);
      updateIngameClock();
      saveIngameTimeToCookie();
    }

    function updateIngameClock() {
      const input = document.getElementById('ingame-time');
      const now = new Date();
      const elapsedRealSec = (now - ingameBaseRealTime) / 1000;
      const elapsedIngameMin = Math.floor(elapsedRealSec * 24 / 60);
      const totalMinutes = (ingameBaseTimeMinutes + elapsedIngameMin) % 1440;
      const h = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
      const m = String(totalMinutes % 60).padStart(2, '0');
      input.value = `${h}:${m}`;
      checkAlarmTrigger(totalMinutes);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadTransFromCookie();
      loadIngameTimeFromCookie();
      loadAlarmStatesFromCookie();
      renderAlarmList();
    });

    const memos = [];
    let memoId = 0;

    function saveMemosToCookie() {
      const contents = memos.map(q => q.editor.root.innerHTML);
      document.cookie = `memoList=${encodeURIComponent(JSON.stringify(contents))}; path=/; max-age=31536000`;
    }

    function loadMemosFromCookie() {
      if (memosLoaded) return;
      memosLoaded = true;

      const match = document.cookie.match(/(?:^|; )memoList=([^;]*)/);
      if (match) {
        try {
          const list = JSON.parse(decodeURIComponent(match[1]));
          if (Array.isArray(list)) list.forEach(html => addMemo(html));
        } catch (e) {
          console.error('메모 로드 오류:', e);
        }
      }
    }

    function addMemo(content = '', title = '') {
      const id = `memo-${memoId++}`;
      const memoWrapper = document.createElement('div');
      memoWrapper.className = 'memo';
      memoWrapper.innerHTML = `
        <div class="memo-header" onclick="toggleMemo('${id}')">
          <input class="memo-title" placeholder="제목 없음" value="${title || '메모 ' + memoId}" oninput="saveMemosToCookie()" onclick="event.stopPropagation()" />
          <button onclick="deleteMemo(event, '${id}')">삭제</button>
        </div>
        <div class="memo-content active" id="${id}">
          <div class="quill-editor"></div>
        </div>
      `;
      document.getElementById('memo-list').appendChild(memoWrapper);

      const editor = new Quill(memoWrapper.querySelector('.quill-editor'), {
        theme: 'snow'
      });
      editor.root.innerHTML = content;
      editor.on('text-change', saveMemosToCookie);
      memos.push({ id, editor, titleInput: memoWrapper.querySelector('.memo-title') });
      saveMemosToCookie();
    }

    function saveMemosToCookie() {
      const contents = memos.map(m => ({
        html: m.editor.root.innerHTML,
        title: m.titleInput?.value || ''
      }));
      document.cookie = `memoList=${encodeURIComponent(JSON.stringify(contents))}; path=/; max-age=31536000`;
    }

    function loadMemosFromCookie() {
      const match = document.cookie.match(/(?:^|; )memoList=([^;]*)/);
      if (match) {
        try {
          const list = JSON.parse(decodeURIComponent(match[1]));
          if (Array.isArray(list)) list.forEach(m => addMemo(m.html, m.title));
        } catch (e) {
          console.error('메모 로드 오류:', e);
        }
      }
    }

    function toggleMemo(id) {
      const content = document.getElementById(id);
      content.classList.toggle('active');
    }

    function deleteMemo(e, id) {
      e.stopPropagation();
      const index = memos.findIndex(m => m.id === id);
      if (index !== -1) memos.splice(index, 1);
      const el = document.getElementById(id).closest('.memo');
      el.classList.add('fade-out');
      setTimeout(() => el.remove(), 1000);
      saveMemosToCookie();
    }

    function toggleMemoGroupFloating() {
      const group = document.getElementById('memo-group');
      const btn = document.getElementById('memo-float-toggle');
      const collapsed = group.classList.toggle('collapsed');
      btn.textContent = collapsed ? '📂' : '📑';
    }

    document.addEventListener('keydown', function (e) {
      if (e.target.classList.contains('memo-title') && e.key === 'Enter') {
        e.preventDefault();
        e.target.blur();
      }
    });

    const resizer = document.getElementById('resizer');
    const leftPane = document.getElementById('memo-pane');
    let isResizing = false;
    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      document.addEventListener('mousemove', resizePane);
      document.addEventListener('mouseup', () => {
        isResizing = false;
        document.removeEventListener('mousemove', resizePane);
      });
    });
    function resizePane(e) {
      if (!isResizing) return;
      const width = Math.max(250, e.clientX);
      leftPane.style.width = width + 'px';
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadMemosFromCookie();
    });
    
    const timers = new Map();

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ko-KR";
      utterance.pitch = 1.5;
      utterance.rate = 1.3;
      utterance.volume = window.__ttsVolume ?? 0.5;
      speechSynthesis.speak(utterance);
    }

    function resetTimer(el, isReset = false) {
      const timerEl = el.previousElementSibling;
      const eventLabelEl = el.parentElement.querySelector('.event-label');
      const progressBar = el.parentElement.nextElementSibling;
      const progressEl = progressBar.querySelector('.progress');
      const characterName = el.closest('.character-box').querySelector('.character-name').value || '캐릭터';
      const eventLabel = eventLabelEl.textContent;

      const interval = timers.get(timerEl);
      if (interval) clearInterval(interval);

      eventLabelEl.style.opacity = '1';
      timerEl.textContent = '00:00:00';
      progressEl.style.width = '0%';
      progressBar.style.display = 'none';
      el.textContent = '완료하기';

      if (!isReset) {
        const alarmToggle = el.closest('.character-box').querySelector('.alarm-check');
        if (alarmToggle.checked) {
          speak(`${characterName}, ${eventLabel} 이벤트 고고!`);
        }
      }
    }

    function startTimer(el) {
      const timerEl = el.previousElementSibling;
      const eventLabelEl = el.parentElement.querySelector('.event-label');
      const progressBar = el.parentElement.nextElementSibling;
      const progressEl = progressBar.querySelector('.progress');
      const eventLabel = eventLabelEl.textContent;
      const characterName = el.closest('.character-box').querySelector('.character-name').value || '캐릭터';

      if (el.textContent === '쿨타임중') {
        resetTimer(el, true);
        return;
      }

      eventLabelEl.style.opacity = '0.5';
      progressBar.style.display = 'block';
      el.textContent = '쿨타임중';

      const startTimestamp = Date.now();
      const endTimestamp = startTimestamp + 60 * 60 * 1000;

      const interval = setInterval(() => {
        const now = Date.now();
        let remaining = Math.max(0, Math.floor((endTimestamp - now) / 1000));

        const h = String(Math.floor(remaining / 3600)).padStart(2, '0');
        const m = String(Math.floor((remaining % 3600) / 60)).padStart(2, '0');
        const s = String(remaining % 60).padStart(2, '0');
        timerEl.textContent = `${h}:${m}:${s}`;

        progressEl.style.width = `${((3600 - remaining) / 3600) * 100}%`;

        if (remaining <= 0) {
          clearInterval(interval);
          resetTimer(el);
        }
      }, 1000);

      timers.set(timerEl, interval);
    }

    const EVENT_MAP = {
      '케이론': 'https://icons.iconarchive.com/icons/seanau/user/256/Thief-icon.png',
      '다크사이트': 'https://icons.iconarchive.com/icons/papirus-team/papirus-apps/256/amnesia-the-dark-descent-icon.png',
      '타락한낙원': 'https://icons.iconarchive.com/icons/mathijssen/tuxlets/256/Devil-Tux-icon.png',
      '디스코': 'https://icons.iconarchive.com/icons/tanitakawkaw/simple-cute/256/music-icon.png',
      '지옥길': 'https://icons.iconarchive.com/icons/google/noto-emoji-travel-places/256/42697-fire-icon.png'
    };

    function addCharacterBox(name = '') {
    const box = document.createElement('div');
    box.className = 'character-box';
    box.innerHTML = `
      <input class="character-name" type="text" placeholder="캐릭터명" value="${name}" onchange="saveCharacterNamesToCookie()" />
      ${['지옥길', '케이론', '다크사이트', '타락한낙원', '디스코'].map(label => `
        <div class="event-row">
          <div class="event-main">
            <img src="${EVENT_MAP[label] || ''}" alt="아이콘" class="event-icon" />
            <div class="event-label">${label}</div>
            <div class="timer">00:00:00</div>
            <button class="complete-btn">완료하기</button>
          </div>
          <div class="progress-bar" style="display: none;"><div class="progress"></div></div>
        </div>
      `).join('')}
      <div class="alarm-toggle">
        <span><input type="checkbox" class="alarm-check" checked /> <label>음성 알림 켜기</label></span>
        <button class="delete-btn" onclick="deleteCharacterBox(this)">삭제</button>
      </div>
    `;
    box.querySelectorAll('.complete-btn').forEach(btn => {
      btn.addEventListener('click', () => startTimer(btn));
    });
    document.getElementById('container').appendChild(box);
    saveCharacterNamesToCookie();
  }

    function deleteCharacterBox(btn) {
      const box = btn.closest('.character-box');
      box.remove();
      saveCharacterNamesToCookie();
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      document.cookie = `theme=${isDark ? 'dark' : 'light'}; path=/; max-age=31536000`;
    }

    function saveCharacterNamesToCookie() {
      const names = Array.from(document.querySelectorAll('.character-name')).map(input => input.value);
      document.cookie = `characterNames=${encodeURIComponent(JSON.stringify(names))}; path=/; max-age=31536000`;
    }

    function loadCharacterNamesFromCookie() {
      const match = document.cookie.match(/(?:^|; )characterNames=([^;]*)/);
      if (match) {
        try {
          const names = JSON.parse(decodeURIComponent(match[1]));
          if (Array.isArray(names)) {
            names.forEach(name => addCharacterBox(name));
            return;
          }
        } catch (e) {
          console.error('쿠키 파싱 에러:', e);
        }
      }
      addCharacterBox();
    }

    (function loadThemeFromCookie() {
      const match = document.cookie.match(/(?:^|; )theme=([^;]*)/);
      if (match && match[1] === 'dark') {
        document.body.classList.add('dark');
      }
    })();

    window.addEventListener('DOMContentLoaded', () => {
      loadGlobalSettingsFromCookie();
      loadCharacterNamesFromCookie();
      loadMemosFromCookie();
    });
  </script>
</body>
</html>
